<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UBIK Solutions Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; }
    .header { background-color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header-logo { font-size: 1.5rem; font-weight: bold; }
    .header-logo span { color: #E91E63; }
    .container { max-width: 600px; margin: auto; padding: 2rem; display: flex; flex-direction: column; }
    #avatar-container { width: 100%; height: 250px; background: url('/static/ubik-01.jpg') center/cover; border-radius: 12px; overflow: hidden; position: relative; }
    #avatar-canvas { width: 100%; height: 100%; display: block; }
    .quiz-buttons { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 1rem; margin-bottom: 1rem; }
    .quiz-buttons button { display: flex; align-items: center; background-color: #E91E63; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 14px; cursor: pointer; transition: background 0.2s ease; gap: 8px; }
    .quiz-buttons button:hover { background-color: #d81b60; }
    .quiz-buttons .icon { width: 20px; height: 20px; }
    .quiz-box { background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .question-area h2 { font-size: 20px; font-weight: bold; margin-bottom: 0.5rem; }
    .question-area p { font-size: 16px; margin-bottom: 1rem; }
    .input-area { display: flex; align-items: center; background: #f9f9f9; border: 1px solid #ddd; border-radius: 30px; padding: 8px 12px; }
    .input-area textarea { flex: 1; font-size: 16px; background: transparent; font-family: 'Roboto', sans-serif; border: none; outline: none; resize: none; height: 50px; }
    .input-area button { background: #E91E63; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; margin-left: 5px; cursor: pointer; }
    .input-area img { width: 20px; height: 20px; }
    .nav-buttons { display: flex; justify-content: space-between; margin-top: 1.5rem; }
    .nav-buttons button { flex: 1; margin: 0 5px; padding: 12px; border-radius: 8px; font-weight: 600; font-size: 14px; background-color: white; color: #E91E63; border: 2px solid #E91E63; cursor: pointer; }
    .nav-buttons button.active { background-color: #E91E63; color: white; }
    .results, .summary-report { margin-top: 1rem; padding: 1rem; border-radius: 12px; display: none; }
    .results { background: #fce4ec; border-left: 4px solid #E91E63; }
    .summary-report { background: #e1f5fe; border-left: 4px solid #E91E63; }
    .summary-report h3 { font-size: 18px; font-weight: bold; margin-bottom: 0.5rem; }
    .summary-report p { font-size: 14px; margin-bottom: 0.5rem; }
    #waveform { display: none; margin-left: 10px; }
    #waveform .dot { width: 12px; height: 12px; background-color: #E91E63; border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.8); opacity: 0.4; } 100% { transform: scale(1); opacity: 0.8; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
  <header class="header">
    <div class="header-logo">UBIK <span>SOLUTIONS</span></div>
    <div class="header-logo">AI <span>DERMAT</span></div>
  </header>
  <div class="container">
    <div id="avatar-container">
      <canvas id="avatar-canvas"></canvas>
    </div>
    <div class="quiz-buttons">
      <button onclick="repeatQuestion()"><img src="/static/repeat.png" class="icon" /> Repeat</button>
      <button onclick="startListening()"><img src="/static/mic.png" class="icon" /> Record</button>
      <button onclick="skipQuestion()"><img src="/static/skip.png" class="icon" /> Skip</button>
    </div>
    <div class="quiz-box">
      <div id="question-area" class="question-area">
        <h2>Question <span id="questionNumber">1</span></h2>
        <p id="questionText">Loading question...</p>
      </div>
      <div class="input-area">
        <textarea id="answerInput" placeholder="Type your answer or use voice..."></textarea>
        <button onclick="submitAnswer()"><img src="/static/send.png" alt="Send"></button>
        <div id="waveform"><div class="dot"></div></div>
      </div>
      <div id="results" class="results">
        <h3>Quiz Results</h3>
        <div id="feedback"></div>
      </div>
      <div id="summary-report" class="summary-report">
        <h3>Quiz Summary Report</h3>
        <div id="summary-content"></div>
      </div>
    </div>
    <div class="nav-buttons">
      <button onclick="location.href='/'">AI Assist</button>
      <button class="active" onclick="location.href='/quiz'">AI Dermat</button>
    </div>
  </div>

  <script>
    // ---------------- Avatar 3D Setup ----------------
    let mixer, clock = new THREE.Clock();
    let animations = {}, rootBone = null, morphDict, morphInfluences;

    function loadModelAnimations(gltf) {
      mixer = new THREE.AnimationMixer(gltf.scene);
      if (gltf.animations.length) {
        animations.Idle = mixer.clipAction(gltf.animations[0]);
        animations.Idle.setLoop(THREE.LoopRepeat);
        animations.Idle.play();
      }
      gltf.scene.traverse(c => { if(c.isBone && c.name.toLowerCase().includes("root")) rootBone = c; });
    }

    function animateAvatar() { requestAnimationFrame(animateAvatar); const delta = clock.getDelta(); if(mixer) mixer.update(delta); if(rootBone) rootBone.rotation.y = 0; }
    animateAvatar();

    function initAvatar() {
      const canvas = document.getElementById('avatar-canvas');
      const container = document.getElementById('avatar-container');
      const bounds = container.getBoundingClientRect();
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(30, bounds.width/bounds.height, 0.01, 5000);
      camera.position.set(0,0,3.5);

      const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
      renderer.setSize(bounds.width, bounds.height);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.enabled = true;

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.enableZoom = controls.enablePan = controls.enableRotate = false; controls.update();

      const loader = new THREE.GLTFLoader();
      loader.load('static/male_char_LightBaked_15thJuly.glb', function(gltf){
        const model = gltf.scene;
        model.position.set(0,-4.7,0); model.rotation.set(0,0.1,0); model.scale.set(3,3,3);
        scene.add(model);
        loadModelAnimations(gltf);

        let skinnedMesh;
        model.traverse(c => { if(c.isSkinnedMesh && c.morphTargetDictionary) skinnedMesh=c; });
        if(skinnedMesh){
          morphDict = skinnedMesh.morphTargetDictionary;
          morphInfluences = skinnedMesh.morphTargetInfluences;
        }

        function renderLoop(){ requestAnimationFrame(renderLoop); controls.update(); renderer.render(scene,camera); }
        renderLoop();
      }, undefined, e=>console.error('Error loading GLB:', e));

      window.addEventListener('resize',()=>{
        const newBounds = container.getBoundingClientRect();
        camera.aspect = newBounds.width/newBounds.height;
        camera.updateProjectionMatrix();
        renderer.setSize(newBounds.width,newBounds.height);
      });
    }
    initAvatar();

    // ---------------- Quiz Logic ----------------
    let currentQuestion = 0, questions = [], answers = {};
    const totalQuestions = 5;

    function speak(text){ if('speechSynthesis' in window){ let u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.speak(u); }}

    function displayQuestion(){
      if(currentQuestion<totalQuestions && questions[currentQuestion]){
        document.getElementById('avatar-container').style.display='block';
        document.getElementById('question-area').style.display='block';
        document.querySelector('.input-area').style.display='flex';
        document.querySelector('.quiz-buttons').style.display='flex';

        document.getElementById('questionNumber').textContent=currentQuestion+1;
        document.getElementById('questionText').textContent=questions[currentQuestion];
        speak(questions[currentQuestion]);
        document.getElementById('answerInput').value='';
        document.getElementById('results').style.display='none';
        document.getElementById('summary-report').style.display='none';
      } else {
        document.getElementById('avatar-container').style.display='none';
        document.getElementById('question-area').style.display='none';
        document.querySelector('.input-area').style.display='none';
        document.querySelector('.quiz-buttons').style.display='none';
        document.getElementById('results').style.display='block';
        document.getElementById('results').innerHTML='<h3>Generating report...</h3>';
        evaluateQuiz();
      }
    }

    function repeatQuestion(){ if(currentQuestion<totalQuestions) speak(questions[currentQuestion]); }
    function submitAnswer(){ const a=document.getElementById('answerInput').value.trim(); if(a){ answers[currentQuestion]=a; currentQuestion++; displayQuestion(); } }
    function skipQuestion(){ answers[currentQuestion]='SKIPPED'; currentQuestion++; displayQuestion(); }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang='en-US'; recognition.interimResults=false; recognition.continuous=false;

    function startListening(){ recognition.start(); document.getElementById('waveform').style.display='block'; }

    recognition.onresult=function(e){ const t=e.results[0][0].transcript; document.getElementById('answerInput').value=t; submitAnswer(); document.getElementById('waveform').style.display='none'; }
    recognition.onerror=recognition.onend=function(){ document.getElementById('waveform').style.display='none'; }

    // ---------------- Fetch Questions ----------------
  fetch('api/questions')

      .then(res=>res.json())
      .then(data=>{
        let arr=[];
        if(Array.isArray(data)) arr=data;
        else if(data.questions && Array.isArray(data.questions)) arr=data.questions;
        questions=arr.map(q=>(!q.startsWith('How')&&!q.startsWith('What')&&!q.startsWith('Why'))?`How does UBIK Solutions ensure ${q.toLowerCase()}?`:q);
        displayQuestion();
      }).catch(e=>{ console.error('Error fetching questions:',e); document.getElementById('questionText').textContent='Error loading questions.'; });

    // ---------------- Quiz Evaluation ----------------
    function evaluateQuiz(){
      const resultsDiv=document.getElementById('results');
      let totalScore=0, correctAnswers=0;
      const feedbackArray=Array(totalQuestions).fill('');

      const promises=questions.map((q,i)=>{
        const answer=answers[i]||'SKIPPED';
        return fetch('/api/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,answer})})
          .then(r=>r.json())
          .then(data=>{
            const score=data.score||0;
            const correctAnswer=data.correct_answer||'N/A';
            const feedbackText=data.feedback||'No feedback available.';
            totalScore+=score; if(score>=0.8) correctAnswers++;

            let questionHTML=`<div style="background:#fff59d;padding:8px;border-radius:6px;margin-top:10px;"><strong>Q${i+1}:</strong> ${q}</div>`;
            let userHTML='';
            if(answer==='SKIPPED') userHTML=`<div style="background:#ef9a9a;padding:6px;border-radius:6px;margin-top:2px;"><strong>Your Answer:</strong> SKIPPED</div>`;
            else if(score>=0.8) userHTML=`<div style="background:#a5d6a7;padding:6px;border-radius:6px;margin-top:2px;"><strong>Your Answer (Correct!):</strong> ${answer}</div>`;
            else userHTML=`<div style="background:#ef9a9a;padding:6px;border-radius:6px;margin-top:2px;"><strong>Your Answer:</strong> ${answer}</div>`;

            let correctHTML='';
            if(score<0.8 && correctAnswer!=='N/A') correctHTML=`<div style="background:#a5d6a7;padding:6px;border-radius:6px;margin-top:2px;"><strong>Correct Answer:</strong> ${correctAnswer}</div>`;
            const feedbackHTML=`<div style="margin-top:4px;font-style:italic;font-size:14px;">${feedbackText}</div>`;

            feedbackArray[i]=questionHTML+userHTML+correctHTML+feedbackHTML;
          }).catch(e=>{ console.error('Error evaluating:',e); feedbackArray[i]=`<div style="background:#fff59d;padding:8px;border-radius:6px;margin-top:10px;"><strong>Q${i+1}:</strong> ${q}</div><div style="background:#ef9a9a;padding:6px;border-radius:6px;">Error evaluating this question.</div>`; });
      });

      Promise.all(promises).then(()=>{
        const avg=(totalScore/totalQuestions).toFixed(2);
        const pct=((avg/1.0)*100).toFixed(0);
        const scoreHTML=`<div style="padding:10px;background:#e0f7fa;border-radius:8px;margin-bottom:12px;"><strong>Total Score:</strong> ${avg}/1.0 (${pct}%)<br><strong>Correct Answers:</strong> ${correctAnswers} out of ${totalQuestions}</div>`;
        resultsDiv.innerHTML=scoreHTML+feedbackArray.join('');
        document.querySelector('.nav-buttons').style.display='flex';
        document.getElementById('answerInput').disabled=true;
      });
    }
  </script>
</body>
</html>
